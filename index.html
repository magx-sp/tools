<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>面付シュミレーター</title>
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { font-family: sans-serif; margin: 0; padding: 0; }
    .container { display: flex; height: 100vh; }
    .controls { width: 320px; padding: 1rem; border-right: 1px solid #ddd; overflow-y: auto; }
    .controls label { display: block; margin-bottom: 0.75rem; font-size: 0.9rem; }
    .controls .pair { display: flex; gap: 0.5rem; }
    .controls .pair label { flex: 1; }
    .controls input[type="number"], .controls select { width: 100%; margin-top: 0.25rem; padding: 4px; }
    .controls input[disabled] { background: #f0f0f0; }
    .checkbox-label { display: flex; align-items: center; margin-bottom: 0.75rem; font-size: 0.9rem; }
    .checkbox-label input { margin-right: 0.5rem; }
    .layout {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 1rem;
    height: 100vh;
    overflow: hidden;
  }
    #pdfArea {
    flex: 1;
    padding: 0;
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
  }
    #canvas { width: 100%; height: auto; }
    .margin-labels { font-size: 0.9rem; text-align: center; margin-top: 0.5rem; }
    #buttons { margin-top: 0.5rem; display: flex; gap: 0.5rem; }
    #buttons button { flex: 1; font-size: 1em; padding: 0.75em; width: 100%; }
    #resultTable { width: 100%; border-collapse: collapse; margin-top: 0.5rem; font-size: 0.9rem; }
    /* 結果表示のスタイル調整 */
    #resultTable th, #resultTable td { border: 1px solid #999; padding: 6px; text-align: left; }
    #resultTable th { background: #f0f0f0; text-align: center; }
    #resultBody td { vertical-align: top; /* 上揃え */ }
    #resultBody td:first-child { width: 120px; /* 左側の列の幅を調整 */ font-weight: bold; /* 左側のテキストを太字に */ }
    #resultBody .sub-item { padding-left: 20px; /* サブ項目のインデント */ }


    #calcSheetsBtn { width: 100%; height: 3em; margin: 0.75rem 0; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="controls">
      <label>原紙寸法
        <select id="paperType">
          <option value="939,636">菊全判 (939×636 mm)</option>
          <option value="636,469">菊半裁 (636×469 mm)</option>
          <option value="1091,788">四六全判 (1091×788 mm)</option>
          <option value="788,545">四六半裁 (788×545 mm)</option>
        </select>
      </label>
      <label>製品サイズ 横 (mm)
        <input type="number" id="itemWidth" value="210" min="1">
      </label>
      <label>製品サイズ 縦 (mm)
        <input type="number" id="itemHeight" value="297" min="1">
      </label>
      <label class="checkbox-label"><input type="checkbox" id="rotate"> 回転する</label>
      <label>ドブ 長辺側 (mm)
        <input type="number" id="bleedLong" value="6" min="0">
      </label>
      <label>ドブ 短辺側 (mm)
        <input type="number" id="bleedShort" value="6" min="0">
      </label>
      <label>クワエ 下余白 (mm)
        <input type="number" id="marginBottom" value="15" min="0">
      </label>
      <label>ハリ 右余白 (mm)
        <input type="number" id="marginRight" value="10" min="0">
      </label>
      <label>印刷数量
        <input type="number" id="quantity" value="0" min="0">
      </label>
      <div class="pair">
        <label>面付調整 長辺数
          <input type="number" id="overrideX" min="1" disabled>
        </label>
        <label>面付調整 短辺数
          <input type="number" id="overrideY" min="1" disabled>
        </label>
      </div>
      <button id="calcSheetsBtn">計算</button>
      <label class="checkbox-label"><input type="checkbox" id="multiDesign"> 複数デザインあり</label>
      <div id="designInputs" style="display:none;">
        <label>デザイン数
          <input type="number" id="designCount" value="2" min="1">
        </label>
        <div id="designList"></div>
        <label>並び順:
          <select id="orderType">
            <option value="row">行ごと</option>
            <option value="col">列ごと</option>
          </select>
        </label>
      </div>
    </div>
    <div class="layout">
      <div id="pdfArea">
        <svg id="canvas" xmlns="http://www.w3.org/2000/svg"></svg>
        <div class="margin-labels" id="margins"></div>
        <table id="resultTable">
          <thead><tr><th colspan="2">結果</th></tr></thead>
          <tbody id="resultBody"></tbody>
        </table>
      </div>
      <div id="buttons">
        <button id="downloadSvgBtn">SVGダウンロード</button>
        <button id="downloadPdfBtn">PDFダウンロード</button>
      </div>
    </div>
  </div>
  <script>
    const ns = 'http://www.w3.org/2000/svg';
    const canvas = document.getElementById('canvas');
    const paperType = document.getElementById('paperType');
    const itemW = document.getElementById('itemWidth');
    const itemH = document.getElementById('itemHeight');
    const rotate = document.getElementById('rotate');
    const bleedLong = document.getElementById('bleedLong');
    const bleedShort = document.getElementById('bleedShort');
    const mbottom = document.getElementById('marginBottom');
    const marginRight = document.getElementById('marginRight');
    const quantityInput = document.getElementById('quantity');
    const overrideX = document.getElementById('overrideX');
    const overrideY = document.getElementById('overrideY');
    const calcBtn = document.getElementById('calcSheetsBtn');
    const multiDesign = document.getElementById('multiDesign');
    const designCount = document.getElementById('designCount');
    const designList = document.getElementById('designList');
    const designInputs = document.getElementById('designInputs');
    const orderType = document.getElementById('orderType');
    const marginsEl = document.getElementById('margins');
    const resultBody = document.getElementById('resultBody');
    const downloadSvgBtn = document.getElementById('downloadSvgBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');

    // 計算結果を保持するためのグローバル変数
    let currentLayoutResults = null;

    function findOptimalLayout(req, total) {
      let best = null;
      function gen(i, rem, arr) {
        if (i === req.length - 1) { if (rem >= 1) evaluate(arr.concat(rem)); return; }
        for (let x = 1; x <= rem - (req.length - i - 1); x++) gen(i+1, rem-x, arr.concat(x));
      }
      function evaluate(layout) {
        const plates = layout.map((f,i) => Math.ceil(req[i]/f));
        const mp = Math.max(...plates);
        const actual = layout.map(f => f*mp);
        const over = actual.map((a,i) => a-req[i]);
        const totalOver = over.reduce((s,v)=>s+v,0);
        if (!best || totalOver < best.totalOver) best={layout,plates:mp,actual,over,totalOver};
      }
      gen(0, total, []);
      return best;
    }

    function setupDesignInputs() {
      designInputs.style.display=multiDesign.checked ? 'block' : 'none';
      designList.innerHTML='';
      const n = parseInt(designCount.value,10)||1;
      for (let i=1; i<=n; i++) {
        const div = document.createElement('div');
        div.innerHTML = `<label>デザイン${i}／印刷数量<br><input type=\"number\" id=\"dq${i}\" value=\"0\" min=\"0\"></label>`;
        designList.appendChild(div);
        document.getElementById(`dq${i}`).addEventListener('input', render);
      }
      quantityInput.disabled = multiDesign.checked;
      // マルチデザインのチェック状態が変わったら、計算結果をクリアして再計算を促す
      currentLayoutResults = null;
      calculate(); // setupDesignInputsが呼ばれるたびにcalculateも呼ぶ
    }

    function calcLayout() {
      const [sw, sh] = paperType.value.split(',').map(Number);
      let w = +itemW.value, h = +itemH.value;
      if (rotate.checked) [w,h]=[h,w];
      const bl = +bleedLong.value, bs = +bleedShort.value, mb = +mbottom.value, hr = +marginRight.value;
      const tw = w+bl, th = h+bs;
      const autoCx = Math.max(1, Math.floor((sw-hr)/tw));
      const autoCy = Math.max(1, Math.floor((sh-mb)/th));

      // overrideの値がない場合は自動計算値を設定
      const currentOverrideX = overrideX.value ? +overrideX.value : null;
      const currentOverrideY = overrideY.value ? +overrideY.value : null;

      const cx = currentOverrideX !== null ? currentOverrideX : autoCx;
      const cy = currentOverrideY !== null ? currentOverrideY : autoCy;

      overrideX.disabled=false;
      overrideY.disabled=false;

      if (overrideX.value === '' || isNaN(currentOverrideX)) {
        overrideX.value = autoCx;
      }
      if (overrideY.value === '' || isNaN(currentOverrideY)) {
        overrideY.value = autoCy;
      }

      return {sw,sh,w,h,bl,bs,mb,hr,tw,th,cx,cy,total:cx*cy};
    }

    function render() {
      const L=calcLayout();
      canvas.setAttribute('viewBox',`0 0 ${L.sw} ${L.sh}`);
      canvas.innerHTML='';
      const frame=document.createElementNS(ns,'rect');
      frame.setAttribute('x',0); frame.setAttribute('y',0);
      frame.setAttribute('width',L.sw); frame.setAttribute('height',L.sh);
      frame.setAttribute('fill','none'); frame.setAttribute('stroke','#333');
      canvas.appendChild(frame);
      const startX=L.sw - L.hr - L.cx * L.tw + L.bl;
      const startY=L.sh - L.mb - L.cy * L.th + L.bs;
      const cols=['#add8e6','#ffb6c1','#90ee90','#ffa500','#dda0dd','#87ceeb','#98fb98','#f08080','#e0ffff','#f5deb3'];
      const n=parseInt(designCount.value,10)||1;

      // 面付イメージに反映するためのデザイン順序配列を生成
      let effectiveSeq = [];
      if (multiDesign.checked && currentLayoutResults && currentLayoutResults.layout) {
        const layoutCounts = currentLayoutResults.layout; // 例: [4, 8]
        const totalCells = L.cx * L.cy;
        let designIndex = 0;
        let currentDesignAccumulatedCount = 0;

        const targetDesignCounts = [];
        for (let i = 0; i < layoutCounts.length; i++) {
            targetDesignCounts.push(layoutCounts[i]);
        }

        for (let k = 0; k < totalCells; k++) {
          if (designIndex < targetDesignCounts.length) {
            effectiveSeq.push(designIndex);
            currentDesignAccumulatedCount++;
            if (currentDesignAccumulatedCount >= targetDesignCounts[designIndex]) {
              designIndex++;
              currentDesignAccumulatedCount = 0;
            }
          } else {
            effectiveSeq.push(0);
          }
        }
      } else {
          for (let k = 0; k < L.cx * L.cy; k++) {
              effectiveSeq.push(0);
          }
      }


      for(let i=0;i<L.cy;i++){
        for(let j=0;j<L.cx;j++){
          let idx=0;
          if(multiDesign.checked) {
            if (orderType.value === 'row') {
              idx = effectiveSeq[i*L.cx+j] !== undefined ? effectiveSeq[i*L.cx+j] : 0;
            } else { // 'col'
              idx = effectiveSeq[j*L.cy+i] !== undefined ? effectiveSeq[j*L.cy+i] : 0;
            }
          }
          const r=document.createElementNS(ns,'rect');
          r.setAttribute('x',startX+j*L.tw); r.setAttribute('y',startY+i*L.th);
          r.setAttribute('width',L.w); r.setAttribute('height',L.h); r.setAttribute('fill',cols[idx % cols.length]);
          r.setAttribute('stroke','#666');
          canvas.appendChild(r);
          if(multiDesign.checked){
            const t=document.createElementNS(ns,'text');
            t.setAttribute('x',startX+j*L.tw+L.w/2); t.setAttribute('y',startY+i*L.th+L.h/2);
            t.setAttribute('text-anchor','middle'); t.setAttribute('dominant-baseline','middle');
            t.setAttribute('font-size',Math.min(L.w,L.h)/4); t.textContent=idx+1;
            canvas.appendChild(t);
          }
        }
      }
      const displayLeftMargin = startX;
      const displayTopMargin = startY;
      const displayRightMargin = L.hr; // ハリ
      const displayBottomMargin = L.mb; // クワエ

      marginsEl.textContent=`[余白] 左：${displayLeftMargin.toFixed(1)}mm　右：${displayRightMargin.toFixed(1)}mm　上：${displayTopMargin.toFixed(1)}mm　下：${displayBottomMargin.toFixed(1)}mm`;
    }

    function calculate() {
      const L=calcLayout();
      let tableRows = ''; // HTML文字列を構築するための変数

      if(multiDesign.checked){
        const req=[];
        for(let i=1;i<=parseInt(designCount.value,10);i++) {
          req.push(+document.getElementById(`dq${i}`).value||0);
        }
        const best=findOptimalLayout(req,L.total);
        currentLayoutResults = best; // 計算結果を保存

        // 原紙寸法と製品サイズ
        tableRows += `<tr><td>原紙寸法</td><td>${L.sw}×${L.sh}mm</td></tr>`;
        tableRows += `<tr><td>製品サイズ</td><td>${L.w}×${L.h}mm</td></tr>`;

        // 面付数
        tableRows += `<tr><td>面付数</td><td>`;
        req.forEach((_,i)=>{
          const f=best.layout[i];
          const rows=f/L.cx;
          // 小数点以下2桁表示
          tableRows += `<div>デザイン${i+1}／${L.cx}×${rows.toFixed(2)}＝${f}面</div>`;
        });
        tableRows += `</td></tr>`;

        // 必要原紙
        tableRows += `<tr><td>必要原紙</td><td>${best.plates}枚</td></tr>`;

        // 予備
        tableRows += `<tr><td>予備</td><td>`;
        req.forEach((_,i)=>{
          const o=best.over[i], a=best.actual[i];
          tableRows += `<div>デザイン${i+1}／${o}枚（総印刷枚数：${a}枚）</div>`;
        });
        tableRows += `</td></tr>`;

        // ドブ・クワエ・ハリ
        tableRows += `<tr><td>ドブ・余白</td><td>ドブ：${L.bl}・${L.bs}（長辺・短辺）<br>クワエ：${L.mb}／ハリ：${L.hr}（mm）</td></tr>`;

      } else { // シングルデザインの場合
        const qty=+quantityInput.value||0, sheets=Math.ceil(qty/L.total), res=sheets*L.total-qty;
        currentLayoutResults = null; // シングルデザインの場合はクリア

        tableRows += `<tr><td>原紙寸法</td><td>${L.sw}×${L.sh}mm</td></tr>`;
        tableRows += `<tr><td>製品サイズ</td><td>${L.w}×${L.h}mm</td></tr>`;
        tableRows += `<tr><td>面付数</td><td>${L.cx}×${L.cy}＝${L.total}面</td></tr>`;
        tableRows += `<tr><td>必要原紙</td><td>${sheets}枚</td></tr>`;
        tableRows += `<tr><td>予備</td><td>${res}枚（総印刷枚数：${sheets*L.total}枚）</td></tr>`;
        tableRows += `<tr><td>ドブ・余白</td><td>ドブ：${L.bl}・${L.bs}（長辺・短辺）<br>クワエ：${L.mb}／ハリ：${L.hr}（mm）</td></tr>`;
      }
      resultBody.innerHTML=tableRows;

      // 計算が終わったらSVGを再描画して結果を反映
      render();
    }

    [paperType,itemW,itemH,rotate,bleedLong,bleedShort,mbottom,marginRight].forEach(el=>el.addEventListener('input',()=>{ overrideX.value=''; overrideY.value=''; render(); }));
    overrideX.addEventListener('input',render);
    overrideY.addEventListener('input',render);
    calcBtn.addEventListener('click',calculate);
    downloadSvgBtn.addEventListener('click',()=>{ const vb=canvas.viewBox.baseVal, cl=canvas.cloneNode(true); cl.setAttribute('xmlns',ns); cl.setAttribute('width',vb.width+'mm'); cl.setAttribute('height',vb.height+'mm'); const xml=new XMLSerializer().serializeToString(cl), blob=new Blob([xml],{type:'image/svg+xml'}), url=URL.createObjectURL(blob), a=document.createElement('a'); a.href=url; a.download='layout.svg'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); });
    downloadPdfBtn.addEventListener('click',()=>{
      const { jsPDF }=window.jspdf;
      const pdf=new jsPDF({unit:'mm',format:'a4',orientation:'landscape'});

      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();

      const margin = 10;
      const drawableWidth = pdfWidth - (margin * 2);
      const drawableHeight = pdfHeight - (margin * 2);

      html2canvas(document.getElementById('pdfArea'),{scale:2}).then(imgCan=>{
        const imgData=imgCan.toDataURL('image/jpeg',0.7);

        const capturedWidthPx = imgCan.width;
        const capturedHeightPx = imgCan.height;

        let imgWidthMM;
        let imgHeightMM;

        const imgAspectRatio = capturedWidthPx / capturedHeightPx;
        const drawableAspectRatio = drawableWidth / drawableHeight;

        if (imgAspectRatio > drawableAspectRatio) {
          imgWidthMM = drawableWidth;
          imgHeightMM = drawableWidth / imgAspectRatio;
        } else {
          imgHeightMM = drawableHeight;
          imgWidthMM = drawableHeight * imgAspectRatio;
        }

        const xOffset = margin + (drawableWidth - imgWidthMM) / 2;
        const yOffset = margin + (drawableHeight - imgHeightMM) / 2;

        pdf.addImage(imgData,'JPEG',xOffset,yOffset,imgWidthMM,imgHeightMM);
        pdf.save('layout.pdf');
      });
    });
    multiDesign.addEventListener('change',() => {
        setupDesignInputs();
        render(); // マルチデザインのチェックボックスが変更されたらSVGも更新
    });
    designCount.addEventListener('input',setupDesignInputs);
    orderType.addEventListener('change',render);
    window.addEventListener('DOMContentLoaded',()=>{
        setupDesignInputs(); // 初期ロード時にもデザイン入力欄をセットアップ
        render();
        calculate(); // 初期ロード時に計算結果も表示
    });
  </script>
</body>
</html>